<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devils Den - The Ritual</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Kanit:wght@300;400;600&family=Metal+Mania&family=New+Rocker&family=Nosifer&family=Pirata+One&family=Rubik+Wet+Paint&family=Taviraj:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- COPY STYLE FROM MAIN (FOR CONSISTENCY) --- */
        :root {
            --primary: #dc2626;   
            --secondary: #d4af37; 
            --cursor-grey: #6b7280; 
            --dark-bg: #020202;   
            --bg-overlay: rgba(0, 0, 0, 0.75); 
            --logo-font: "New Rocker", cursive;
            --title-font: "Rubik Wet Paint", system-ui;
            --roman-font: 'Cinzel', serif;
            --body-font: 'Kanit', sans-serif;
            --ancient-thai-font: 'Taviraj', serif;
            --gothic-read-font: 'Pirata One', cursive; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--body-font); cursor: none !important; }
        
        body {
            background-color: var(--dark-bg);
            background: linear-gradient(var(--bg-overlay), var(--bg-overlay)), url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            height: 100vh;
            overflow: hidden; 
            position: relative;
        }

        .bg-fixed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: inherit; z-index: -10; transition: transform 8s ease-in-out; }
        .bg-fixed.zooming { transform: scale(1.2); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 50000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.5s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(145deg, #1a0505, #000); border: 2px solid var(--primary); padding: 60px 40px; border-radius: 15px; text-align: center; transform: scale(0.5); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 50px rgba(220, 38, 38, 0.5); width: 650px; max-width: 90%; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-title { font-family: var(--title-font); font-size: 4rem; color: #fff; margin-bottom: 30px; text-shadow: 0 0 25px var(--primary); }
        .modal-winner-name { font-family: var(--gothic-read-font); font-size: 5rem; color: #dc2626; text-shadow: 2px 2px 0 #000, 0 0 30px #b91c1c; margin: 30px 0; animation: pulse-winner 1s infinite alternate; }
        @keyframes pulse-winner { 0% { transform: scale(1); filter: brightness(1); } 100% { transform: scale(1.05); filter: brightness(1.2); } }
        .modal-close-btn { font-family: var(--logo-font); background: var(--primary); border: none; color: #fff; padding: 15px 50px; font-size: 1.8rem; margin-top: 40px; transition: 0.3s; box-shadow: 0 0 20px var(--primary); cursor: none; }
        .modal-close-btn:hover { background: #fff; color: var(--primary); box-shadow: 0 0 40px var(--primary); }

        /* CURSOR */
        .cursor-main { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 999999; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 22px solid var(--cursor-grey); transform: translate(-50%, -50%) rotate(-30deg); filter: drop-shadow(0 0 5px rgba(0,0,0,0.8)); transition: transform 0.1s; }
        .cursor-main::after { content: ''; position: absolute; top: 15px; left: -2px; width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 5px #fff; }
        .cursor-hover { border-bottom-color: var(--primary); transform: translate(-50%, -50%) rotate(0deg) scale(1.5); filter: drop-shadow(0 0 15px var(--primary)); }

        /* EFFECTS */
        .blood-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; background: radial-gradient(circle, transparent 40%, rgba(185, 28, 28, 0.8) 100%); opacity: 0; transition: opacity 0.1s; mix-blend-mode: hard-light; }
        .blood-overlay.splatter { animation: blood-pulse 0.8s forwards; }
        @keyframes blood-pulse { 0% { opacity: 0; transform: scale(1); } 10% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }
        .flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 60; opacity: 0; background: white; }
        .flash-overlay.thunder { animation: thunder-strobe 0.6s linear; }
        @keyframes thunder-strobe { 0% { opacity: 0; } 5% { opacity: 1; background: #fff; } 10% { opacity: 0; } 15% { opacity: 0.8; background: #ffcccc; } 20% { opacity: 0; } 40% { opacity: 0.4; background: #fff; } 100% { opacity: 0; } }
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
        .fog-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -5; pointer-events: none; }
        .fog-img { position: absolute; height: 100vh; width: 300vw; background: url('https://raw.githubusercontent.com/danielstuart14/CSS_FOG_ANIMATION/master/img/fog1.png') repeat-x; background-size: contain; animation: fog 60s linear infinite; opacity: 0.4; }
        .fog-img-2 { position: absolute; height: 100vh; width: 300vw; background: url('https://raw.githubusercontent.com/danielstuart14/CSS_FOG_ANIMATION/master/img/fog2.png') repeat-x; background-size: contain; animation: fog 40s linear infinite; top: 30%; opacity: 0.3; }
        @keyframes fog { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-200vw, 0, 0); } }
        .mist-particle { position: fixed; pointer-events: none; background: radial-gradient(circle, rgba(100,100,100,0.5) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; z-index: 9998; animation: trail-smoke 1.8s ease-out forwards; filter: blur(8px); }
        @keyframes trail-smoke { 0% { transform: scale(0.5); opacity: 0.6; } 100% { transform: scale(2.5); opacity: 0; } }
        .click-burst { position: fixed; border-radius: 50%; border: 2px solid var(--primary); transform: translate(-50%, -50%); animation: burst 0.6s ease-out forwards; pointer-events: none; z-index: 9998; box-shadow: inset 0 0 20px var(--primary); }
        @keyframes burst { 0% { width: 0; height: 0; opacity: 1; border-width: 4px; } 100% { width: 120px; height: 120px; opacity: 0; border-width: 0px; } }

        /* NAV */
        nav { position: fixed; top: 0; left: 0; width: 100%; z-index: 10000; display: flex; justify-content: space-between; align-items: center; padding: 20px 60px; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); }
        .logo-container { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .logo-main { font-family: var(--logo-font); font-size: 2.2rem; line-height: 1; }
        .logored { color: var(--primary); text-shadow: 0 0 20px var(--primary); }
        .logowhite { color: white; text-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .logo-sub { font-size: 0.65rem; color: #aaa; text-transform: uppercase; letter-spacing: 3px; margin-top: 5px; }
        .nav-right { display: flex; align-items: center; gap: 40px; }
        .nav-links { display: flex; gap: 60px; }
        .nav-links a { text-decoration: none; color: #aaa; font-family: var(--roman-font); font-weight: 700; font-size: 0.9rem; letter-spacing: 2px; transition: 0.3s; }
        .nav-links a:hover { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .audio-toggle-btn { background: transparent; border: 2px solid #444; color: #666; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1rem; cursor: pointer; transition: all 0.3s; }
        .audio-toggle-btn.playing { border-color: var(--primary); color: var(--primary); box-shadow: 0 0 10px var(--primary); animation: pulse-audio 2s infinite; }
        @keyframes pulse-audio { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 100% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } }

        /* DRAW PAGE LAYOUT */
        .section-luckydraw { display: flex; align-items: center; justify-content: center; height: 100vh; width: 100%; }
        .draw-container { position: relative; z-index: 5; width: 100%; max-width: 1200px; display: flex; gap: 40px; align-items: stretch; height: 75vh; }
        .draw-left { 
            flex: 1; display: flex; flex-direction: column; gap: 15px; 
            background: rgba(0, 0, 0, 0.7); padding: 30px; border-radius: 10px; 
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); 
            height: 100%; /* Make it fill container */
            overflow: hidden;
        }
        .draw-title { font-family: var(--title-font); font-size: 2.5rem; color: #fff; text-shadow: 0 0 10px var(--primary); text-align: center; margin-bottom: 5px; }
        
        /* --- MODE SWITCHER STYLES --- */
        .mode-switcher { display: flex; gap: 10px; margin-bottom: 10px; }
        .mode-btn { 
            flex: 1; background: #111; color: #666; border: 1px solid #333; 
            padding: 10px; font-family: var(--logo-font); font-size: 1.2rem; cursor: pointer; 
            transition: 0.3s; letter-spacing: 1px;
        }
        .mode-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        
        /* --- INPUT CONTAINERS --- */
        #normal-input-container { flex: 1; display: flex; flex-direction: column; height: 100%; }
        #group-input-container { flex: 1; display: none; flex-direction: column; height: 100%; overflow: hidden; }

        .name-input { 
            width: 100%; flex: 1; background: rgba(0,0,0,0.6); border: 1px solid #444; 
            color: #eee; padding: 15px; font-family: var(--body-font); font-size: 1rem; 
            resize: none; outline: none; border-radius: 5px; 
        }
        .name-input:focus { border-color: var(--primary); background: rgba(0,0,0,0.8); }

        /* --- GROUP ITEMS STYLES --- */
        .group-list-scroll { flex: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .group-list-scroll::-webkit-scrollbar { width: 5px; }
        .group-list-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 5px; }
        
        .team-box { border: 1px solid #333; background: rgba(20, 20, 20, 0.8); border-radius: 5px; padding: 10px; position: relative; }
        .team-header { font-family: var(--logo-font); color: var(--secondary); font-size: 1.1rem; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .team-input { width: 100%; background: #000; border: 1px solid #333; color: #ccc; padding: 8px; font-size: 0.9rem; resize: vertical; min-height: 60px; outline: none; }
        .team-input:focus { border-color: var(--secondary); }
        .add-team-btn { background: #222; border: 1px dashed #555; color: #888; width: 100%; padding: 10px; cursor: pointer; font-family: var(--body-font); transition: 0.3s; }
        .add-team-btn:hover { background: #333; color: #fff; border-color: #fff; }

        .btn-wrapper { width: 100%; margin-top: 0; }
        .btn-gothic { padding: 15px 50px; font-family: var(--roman-font); font-size: 1.2rem; color: #ccc; font-weight: bold; text-decoration: none; text-transform: uppercase; letter-spacing: 3px; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 4px; display: block; transition: 0.3s; cursor: pointer; width: 100%; }
        .btn-gothic:hover { color: #fff; background: #1a0505; border-color: var(--primary); box-shadow: 0 0 30px rgba(220,38,38,0.5); transform: translateY(-3px); }
        
        .wheel-zone { flex: 1.5; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; background: rgba(0, 0, 0, 0.4); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }

        /* WINNER BOX */
        .winner-display-box { width: 90%; height: 120px; margin-bottom: 25px; background: rgba(0, 0, 0, 0.85); border: 2px solid var(--secondary); border-radius: 10px; display: flex; justify-content: center; align-items: center; text-align: center; box-shadow: 0 0 20px rgba(212, 175, 55, 0.2), inset 0 0 15px rgba(0,0,0,0.8); position: relative; overflow: hidden; padding: 0 20px; white-space: nowrap; }
        .winner-display-box::before { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transform: skewX(-20deg); animation: shine-box 3s infinite; }
        @keyframes shine-box { 0% { left: -100%; } 100% { left: 200%; } }

        .winner-text-animate { font-family: var(--ancient-thai-font); font-size: 2.2rem; font-weight: bold; color: #fff; text-shadow: 0 0 10px var(--primary), 0 0 20px #000; opacity: 0; transform: translateY(10px); transition: all 0.5s ease-out; line-height: 1.3; }
        .winner-text-animate.show { opacity: 1; transform: translateY(0); }
        .winner-text-animate.final { color: #fbbf24; font-size: 1.8rem; text-shadow: 0 0 20px rgba(251, 191, 36, 0.5); animation: pulse-final 1s infinite alternate; }
        @keyframes pulse-final { 0% { transform: scale(1); text-shadow: 0 0 20px rgba(251, 191, 36, 0.5); } 100% { transform: scale(1.05); text-shadow: 0 0 40px rgba(251, 191, 36, 0.8); } }

        /* GLITCH & WHEEL */
        .glitch-text { position: relative; color: #fff; font-size: 2.5rem; animation: glitch-anim 0.3s infinite; text-shadow: 2px 0 var(--primary), -2px 0 blue; opacity: 1 !important; visibility: visible !important; transform: none !important; }
        @keyframes glitch-anim { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        .box-shaking { animation: box-vibrate 0.1s infinite; border-color: #fff !important; background: rgba(220, 38, 38, 0.2) !important; }
        @keyframes box-vibrate { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(1px, 1px) rotate(1deg); } 50% { transform: translate(-1px, -1px) rotate(-1deg); } 75% { transform: translate(-1px, 1px) rotate(0deg); } 100% { transform: translate(1px, -1px) rotate(0deg); } }

        .wheel-outer-rim { position: relative; width: 450px; height: 450px; border-radius: 50%; box-shadow: 0 0 0 10px #1a0505, 0 0 0 12px var(--secondary), 0 0 50px rgba(220, 38, 38, 0.5); background: #000; display: flex; justify-content: center; align-items: center; }
        canvas { width: 100%; height: 100%; border-radius: 50%; transform: rotate(0deg); transition: transform 8s cubic-bezier(0.1, 0.7, 0.1, 1); }
        canvas.motion-blur { filter: blur(3px); }
        .wheel-center-knob { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, var(--secondary), #5e4b10); border-radius: 50%; box-shadow: 0 0 15px #000; z-index: 10; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #2e0f0f; }
        .wheel-center-knob.pulsing { animation: heart-beat 0.8s infinite; }
        @keyframes heart-beat { 0% { transform: scale(1); box-shadow: 0 0 15px #000; } 50% { transform: scale(1.15); box-shadow: 0 0 30px var(--primary); } 100% { transform: scale(1); box-shadow: 0 0 15px #000; } }
        .pointer-arrow { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid var(--primary); filter: drop-shadow(0 0 5px red); z-index: 20; }
        .reset-btn { position: absolute; bottom: 20px; right: 20px; width: 45px; height: 45px; background: rgba(0, 0, 0, 0.7); border: 2px solid var(--secondary); border-radius: 50%; color: var(--secondary); display: flex; justify-content: center; align-items: center; font-size: 1.2rem; z-index: 50; transition: 0.3s; backdrop-filter: blur(5px); }
        .reset-btn:hover { background: var(--secondary); color: #000; box-shadow: 0 0 20px var(--secondary); transform: rotate(180deg); }

        /* FOOTER */
        .site-footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: linear-gradient(to top, #000000 10%, rgba(0,0,0,0) 100%); text-align: center; z-index: 1000; font-family: var(--body-font); border-top: 1px solid rgba(220, 38, 38, 0.1); backdrop-filter: blur(2px); }
        .footer-content { font-size: 0.75rem; color: #666; letter-spacing: 1px; text-transform: uppercase; display: flex; justify-content: center; align-items: center; gap: 15px; }
        .footer-link { color: var(--primary); text-decoration: none; font-weight: bold; transition: all 0.3s ease; }
        .footer-link:hover { color: #fff; text-shadow: 0 0 10px var(--primary); }
        .footer-divider { color: #333; }

    </style>
</head>
<body>

    <div class="bg-fixed" id="bg-fixed"></div>
    <div class="fog-container">
        <div class="fog-img"></div>
        <div class="fog-img-2"></div>
    </div>
    <div id="blood-screen" class="blood-overlay"></div>
    <div id="flash-effect" class="flash-overlay"></div>

    <div id="winner-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">THE CHOSEN ONE</h2>
            <div id="modal-winner-name" class="modal-winner-name">NAME</div>
            <button class="modal-close-btn" onclick="closeModal()" onmouseenter="hoverCursor(true)" onmouseleave="hoverCursor(false)">ACCEPT FATE</button>
        </div>
    </div>

    <div class="cursor-main" id="cursor-main"></div>
    
    <nav>
        <div class="logo-container" onmouseenter="hoverCursor(true)" onmouseleave="hoverCursor(false)">
            <div class="logo-main"><span class="logored">DEVILS-</span><span class="logowhite">DEN</span></div>
            <div class="logo-sub">Official Site</div>
        </div>
        <div class="nav-right">
           <div class="nav-links">
                <a href="/" onmouseenter="hoverCursor(true)" onmouseleave="hoverCursor(false)">HOME</a>

                <a href="https://www.facebook.com/..." ...>CONTACT</a>
            </div>
            <div class="audio-toggle-btn" id="audio-toggle" onclick="toggleMusic()" onmouseenter="hoverCursor(true)" onmouseleave="hoverCursor(false)">
                <i class="fa-solid fa-volume-xmark" id="audio-icon"></i>
            </div>
        </div>
    </nav>

    <section class="section-luckydraw" id="luckydraw">
        <div class="draw-container">
            <div class="draw-left">
                <h2 class="draw-title">DARK RITUAL</h2>
                
                <div class="mode-switcher">
                    <button class="mode-btn active" id="btn-normal" onclick="setMode('normal')">NORMAL</button>
                    <button class="mode-btn" id="btn-group" onclick="setMode('group')">GROUP</button>
                </div>

                <div id="normal-input-container">
                    <textarea id="namesInput" class="name-input" placeholder="รายชื่อเหยื่อ... (บรรทัดละ 1 ชื่อ)" oninput="drawWheel()"></textarea>
                </div>

                <div id="group-input-container">
                    <div id="group-list" class="group-list-scroll">
                        </div>
                    <button class="add-team-btn" onclick="addTeam()">+ SUMMON NEW TEAM</button>
                </div>

                <div class="btn-wrapper" onmouseenter="hoverCursor(true)" onmouseleave="hoverCursor(false)">
                    <button onclick="spinWheel()" id="spin-btn" class="btn-gothic">SUMMON WHEEL</button>
                </div>
            </div>
            <div class="draw-right wheel-zone" id="wheel-area">
                <div class="winner-display-box">
                    <div id="winner-announce" class="winner-text-animate show">READY...</div>
                </div>
                <div class="wheel-outer-rim">
                    <div class="pointer-arrow"></div>
                    <canvas id="wheelCanvas" width="500" height="500"></canvas>
                    <div class="wheel-center-knob" id="wheel-knob">
                        <i class="fa-solid fa-skull"></i>
                    </div>
                </div>
                <button class="reset-btn" onclick="resetWheel()" onmouseenter="hoverCursor(true)" onmouseleave="hoverCursor(false)" title="Reset Ritual">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>
    </section>

    <footer class="site-footer">
        <div class="footer-content">
            <span>&copy; 2026 DEVILS DEN</span>
            <span class="footer-divider">|</span>
            <span>ALL RIGHTS RESERVED</span>
            <span class="footer-divider">|</span>
            <span>DESIGNED BY <a href="#" class="footer-link">DEVILS TEAM</a></span>
        </div>
    </footer>

    <audio id="bg-music" src="/static/sound/bg.mp3" loop></audio>
    <audio id="sfx-spin" src="/static/sound/spin.mp3" loop></audio> 
    <audio id="sfx-cut" src="/static/sound/cut.mp3"></audio>
    <audio id="sfx-win" src="/static/sound/win.mp3"></audio>

    <script>
        // --- BASIC JS ---
        const cursorMain = document.getElementById('cursor-main');
        const bgMusic = document.getElementById('bg-music');
        const audioIcon = document.getElementById('audio-icon');
        const audioBtn = document.getElementById('audio-toggle');
        let isMusicPlaying = false;

        document.addEventListener('mousemove', (e) => {
            cursorMain.style.left = e.clientX + 'px'; cursorMain.style.top = e.clientY + 'px'; createSmoke(e.clientX, e.clientY);
        });
        function hoverCursor(active) { active ? cursorMain.classList.add('cursor-hover') : cursorMain.classList.remove('cursor-hover'); }
        
        function createSmoke(x, y) {
            if(Math.random() > 0.4) return;
            const mist = document.createElement('div'); mist.className = 'mist-particle'; document.body.appendChild(mist);
            const size = Math.random() * 30 + 20; mist.style.width = size + 'px'; mist.style.height = size + 'px';
            const spread = Math.random() * 40 - 20; mist.style.left = (x + spread) + 'px'; mist.style.top = (y + spread) + 'px';
            setTimeout(() => mist.remove(), 1800);
        }
        function createExplosion(x, y) {
            const burst = document.createElement('div'); burst.className = 'click-burst';
            burst.style.left = x + 'px'; burst.style.top = y + 'px';
            document.body.appendChild(burst); setTimeout(() => burst.remove(), 600);
            for(let i=0; i<5; i++) { createSmoke(x, y); }
        }

        document.body.addEventListener('click', () => {
            if (!isMusicPlaying) {
                bgMusic.volume = 0.3;
                bgMusic.play().then(() => {
                    isMusicPlaying = true;
                    audioIcon.className = 'fa-solid fa-volume-high';
                    audioBtn.classList.add('playing');
                }).catch(e => {});
            }
        }, { once: true });

        function toggleMusic() {
            if (isMusicPlaying) { bgMusic.pause(); audioIcon.className = 'fa-solid fa-volume-xmark'; audioBtn.classList.remove('playing'); isMusicPlaying = false; }
            else { bgMusic.volume = 0.3; bgMusic.play(); audioIcon.className = 'fa-solid fa-volume-high'; audioBtn.classList.add('playing'); isMusicPlaying = true; }
        }

        // --- WHEEL & MODE LOGIC ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spin-btn');
        const namesInput = document.getElementById('namesInput'); 
        const winnerAnnounce = document.getElementById('winner-announce');
        const wheelKnob = document.getElementById('wheel-knob');
        const bgFixed = document.querySelector('.bg-fixed'); 
        const winnerModal = document.getElementById('winner-modal');
        const modalWinnerName = document.getElementById('modal-winner-name');
        
        // Mode Elements
        const normalContainer = document.getElementById('normal-input-container');
        const groupContainer = document.getElementById('group-input-container');
        const btnNormal = document.getElementById('btn-normal');
        const btnGroup = document.getElementById('btn-group');
        const groupList = document.getElementById('group-list');

        let currentMode = 'normal'; // 'normal' or 'group'
        let items = []; 
        let currentRotation = 0;
        let isSpinning = false;
        let shuffleInterval = null; 
        
        let groupsData = {}; 
        let isPhase2 = false; 

        const sfxSpin = document.getElementById('sfx-spin');
        const sfxCut = document.getElementById('sfx-cut'); 
        const sfxWin = document.getElementById('sfx-win'); 

        const deathQuotes = [
            "ถูกกลืนกินโดยความมืด", "ถูกลากลงสู่อเวจี", "กลายเป็นเครื่องสังเวย",
            "วิญญาณหลุดลอยไปแล้ว", "ไม่รอดจากเงื้อมมือมาร", "หายไปในความว่างเปล่า"
        ];

        // --- MODE SWITCHING ---
        function setMode(mode) {
            currentMode = mode;
            if(mode === 'normal') {
                normalContainer.style.display = 'flex';
                groupContainer.style.display = 'none';
                btnNormal.classList.add('active');
                btnGroup.classList.remove('active');
            } else {
                normalContainer.style.display = 'none';
                groupContainer.style.display = 'flex';
                btnNormal.classList.remove('active');
                btnGroup.classList.add('active');
                // If no teams, add first two automatically
                if(groupList.children.length === 0) {
                    addTeam(); addTeam();
                }
            }
            // Reset state when switching
            resetWheel();
        }

        // --- GROUP MANAGEMENT ---
        function addTeam() {
            const index = groupList.children.length;
            const teamLetter = String.fromCharCode(65 + index); // A, B, C...
            
            const teamDiv = document.createElement('div');
            teamDiv.className = 'team-box';
            teamDiv.innerHTML = `
                <div class="team-header">TEAM ${teamLetter}</div>
                <textarea class="team-input" placeholder="รายชื่อสมาชิก... (บรรทัดละชื่อ)" oninput="drawWheel()"></textarea>
            `;
            groupList.appendChild(teamDiv);
            drawWheel();
        }

        function parseInput() {
            if (currentMode === 'normal') {
                const text = namesInput.value.trim();
                if(!text) return { mode: 'normal', data: [] };
                const lines = text.split('\n').filter(l => l.trim() !== '');
                return { mode: 'normal', data: lines };
            } else {
                // Group Mode Parsing
                const teamBoxes = document.querySelectorAll('.team-box');
                const gData = {};
                teamBoxes.forEach(box => {
                    const teamName = box.querySelector('.team-header').innerText;
                    const membersText = box.querySelector('.team-input').value;
                    const members = membersText.split('\n').filter(m => m.trim() !== '');
                    if (members.length > 0) {
                        gData[teamName] = members;
                    }
                });
                return { mode: 'group', data: gData };
            }
        }

        function drawWheel() {
            if (!isPhase2) {
                const result = parseInput();
                if (result.mode === 'group') {
                    groupsData = result.data;
                    items = Object.keys(groupsData);
                } else {
                    items = result.data;
                    groupsData = {};
                }
            }
            
            if(items.length === 0) items = ["EMPTY", "VOID", "NULL", "ABYSS"];

            const numSegments = items.length;
            const arcSize = (2 * Math.PI) / numSegments;
            const radius = canvas.width / 2;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for(let i = 0; i < numSegments; i++) {
                const angle = i * arcSize;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, angle, angle + arcSize);
                ctx.closePath();
                ctx.fillStyle = (i % 2 === 0) ? '#8B0000' : '#0f0f0f'; 
                ctx.fill();
                ctx.lineWidth = 3;
                ctx.strokeStyle = "#d4af37";
                ctx.stroke();
                ctx.save();
                ctx.translate(centerX, centerY);

                if (numSegments === 1) {
                      ctx.fillStyle = "#fff";
                      ctx.font = "bold 40px 'Kanit', sans-serif";
                      ctx.textAlign = "center";
                      ctx.textBaseline = "middle";
                      ctx.shadowColor = "black";
                      ctx.shadowBlur = 10;
                      ctx.fillText(items[i], 0, -50); 
                } else {
                    ctx.rotate(angle + arcSize / 2);
                    ctx.textAlign = "right";
                    ctx.fillStyle = "#fff";
                    ctx.font = "bold 24px 'Kanit', sans-serif";
                    ctx.shadowColor = "black";
                    ctx.shadowBlur = 5;
                    ctx.fillText(items[i], radius - 20, 10);
                }
                ctx.restore();
            }
        }

        function startChaosAnimation() {
            const displayBox = document.querySelector('.winner-display-box');
            winnerAnnounce.classList.remove('show');
            winnerAnnounce.classList.add('glitch-text'); 
            displayBox.classList.add('box-shaking');     
            winnerAnnounce.style.opacity = '1';
            winnerAnnounce.style.transform = 'translateY(0)';

            const chaosChars = "#$%&!@^*?"; 

            if (shuffleInterval) clearInterval(shuffleInterval);

            shuffleInterval = setInterval(() => {
                let randomString = "";
                const len = Math.floor(Math.random() * 5) + 6;
                for (let i = 0; i < len; i++) {
                    randomString += chaosChars.charAt(Math.floor(Math.random() * chaosChars.length));
                }
                const colors = ['#fff', '#dc2626', '#888']; 
                winnerAnnounce.style.color = colors[Math.floor(Math.random() * colors.length)];
                winnerAnnounce.innerText = randomString;
            }, 50); 
        }

        function stopChaosAnimation() {
            if(shuffleInterval) clearInterval(shuffleInterval);
            const displayBox = document.querySelector('.winner-display-box');
            winnerAnnounce.classList.remove('glitch-text');
            displayBox.classList.remove('box-shaking');
            winnerAnnounce.style.color = ''; 
            winnerAnnounce.style.opacity = ''; 
        }

        function closeModal() {
            winnerModal.classList.remove('show');
            if (!isSpinning && !isPhase2) {
                winnerAnnounce.classList.add('show'); 
                winnerAnnounce.innerHTML = "READY...";
            }
        }

        function resetWheel() {
            if(isSpinning) return; 
            stopChaosAnimation();
            isPhase2 = false; 
            winnerAnnounce.classList.remove('final');
            winnerAnnounce.classList.add('show'); 
            winnerAnnounce.innerHTML = "READY..."; 

            if (currentMode === 'normal') {
                namesInput.value = "";
            } else {
                // FIXED: Clear and Re-create initial teams
                groupsData = {};
                groupList.innerHTML = '';
                addTeam(); 
                addTeam();
            }
            drawWheel();
        }

        function removeTeamBox(teamName) {
            const boxes = document.querySelectorAll('.team-box');
            boxes.forEach(box => {
                if(box.querySelector('.team-header').innerText === teamName) {
                    box.remove();
                }
            });
        }

        function spinWheel() {
            if(isSpinning) return;
            if (!isPhase2) drawWheel();

            if(items.length === 0 || items[0] === "EMPTY") { alert("ใส่รายชื่อเหยื่อก่อน!"); return; }

            // Phase 2 Transition Logic
            if (!isPhase2 && items.length === 1 && Object.keys(groupsData).length > 0) {
                const survivingGroup = items[0];
                items = groupsData[survivingGroup];
                isPhase2 = true;
                spinBtn.innerText = "FINAL PHASE!";
                winnerAnnounce.innerHTML = "FINAL: " + survivingGroup;
                drawWheel();
                return;
            }

            if (items.length === 1) { displayWinner(items[0], true); return; }

            isSpinning = true;
            spinBtn.innerText = "RITUAL STARTED...";
            bgFixed.classList.add('zooming'); 
            wheelKnob.classList.add('pulsing'); 
            startChaosAnimation();

            canvas.classList.add('motion-blur');
            try { sfxSpin.volume = 0.8; sfxSpin.currentTime = 0; sfxSpin.play().catch(()=>{}); } catch(e){}

            const winnerIndex = Math.floor(Math.random() * items.length); 
            const winnerName = items[winnerIndex];
            const sliceAngle = 360 / items.length;
            const wiggle = (Math.random() - 0.5) * (sliceAngle * 0.8);
            const targetAngleInWheel = (winnerIndex * sliceAngle) + (sliceAngle / 2) + wiggle;

            const baseRotation = currentRotation % 360; 
            const extraSpins = 360 * 15;
            const rotationNeeded = extraSpins + (targetAngleInWheel + 90) - baseRotation;
            
            currentRotation += rotationNeeded;
            canvas.style.transform = `rotate(-${currentRotation}deg)`;

            setTimeout(() => { canvas.classList.remove('motion-blur'); }, 5000);

            setTimeout(() => {
                isSpinning = false;
                stopChaosAnimation(); 
                bgFixed.classList.remove('zooming');
                wheelKnob.classList.remove('pulsing');
                try { sfxSpin.pause(); } catch(e){}

                if (Object.keys(groupsData).length > 0 && !isPhase2) {
                    displayWinner(winnerName + " (ELIMINATED)", false);
                    delete groupsData[winnerName];
                    removeTeamBox(winnerName); 
                    drawWheel(); 
                    spinBtn.innerText = "SUMMON WHEEL";
                } else {
                    displayWinner(winnerName + " (ELIMINATED)", false);
                    items.splice(winnerIndex, 1);
                    if(!isPhase2 && currentMode === 'normal') { namesInput.value = items.join('\n'); }
                    drawWheel();
                    spinBtn.innerText = "SUMMON WHEEL";
                    if (items.length === 1) { setTimeout(() => { displayWinner(items[0], true); }, 4000); }
                }
            }, 8000); 
        }

        function displayWinner(name, isFinal) {
            winnerAnnounce.style.opacity = '';
            winnerAnnounce.classList.remove('show');
            void winnerAnnounce.offsetWidth; 
            const flash = document.getElementById('flash-effect');
            
            if(isFinal) {
                try { sfxWin.currentTime = 0; sfxWin.play().catch(()=>{}); } catch(e){}
                modalWinnerName.innerText = name;
                winnerModal.classList.add('show');
                createExplosion(window.innerWidth/2, window.innerHeight/2);
            } else {
                flash.className = 'flash-overlay thunder';
                void flash.offsetWidth;
                try { sfxCut.currentTime = 0; sfxCut.play().catch(()=>{}); } catch(e){}
                
                const bloodScreen = document.getElementById('blood-screen');
                bloodScreen.classList.remove('splatter');
                void bloodScreen.offsetWidth; 
                bloodScreen.classList.add('splatter');

                const container = document.querySelector('.draw-container');
                if (container) {
                    container.classList.remove('shake-screen');
                    void container.offsetWidth;
                    container.classList.add('shake-screen');
                }

                const randomQuote = deathQuotes[Math.floor(Math.random() * deathQuotes.length)];
                winnerAnnounce.innerHTML = `
                    <span style="color:#ef4444; font-size:1.2em;">${name}</span>
                    <br>
                    <span style="font-size:0.6em; color:#aaa; font-weight:normal;">${randomQuote}</span>
                `;
                winnerAnnounce.classList.add('show');
            }
        }

        window.onload = () => { drawWheel(); };
    </script>
</body>
</html>
